#include <memory>         // Fixes make_unique
#include <chrono>
#include <cuda_runtime.h>

#include "rclcpp/rclcpp.hpp"
#include "std_msgs/msg/float32.hpp" // Fixes std_msgs declaration

using namespace std::chrono_literals;

// 1. Structure must be visible to the Adapter
struct GpuBuffer {
  float* dev_ptr;
};

// 2. The Adapter (Must be in rclcpp namespace)
namespace rclcpp {
template<>
struct TypeAdapter<GpuBuffer, std_msgs::msg::Float32> {
  using is_specialized = std::true_type;
  using custom_type = GpuBuffer;
  using ros_message_type = std_msgs::msg::Float32;

  static void convert_to_ros_message(const custom_type& source, ros_message_type& dest) {
    float host_val;
    cudaMemcpy(&host_val, source.dev_ptr, sizeof(float), cudaMemcpyDeviceToHost);
    dest.data = host_val;
  }

  static void convert_to_custom(const ros_message_type& source, custom_type& dest) {
    cudaMalloc(&dest.dev_ptr, sizeof(float));
    cudaMemcpy(dest.dev_ptr, &source.data, sizeof(float), cudaMemcpyHostToDevice);
  }
};
} // namespace rclcpp

// 3. The Node
class GpuBridgeNode : public rclcpp::Node {
public:
  GpuBridgeNode() : Node("gpu_bridge_node", rclcpp::NodeOptions().use_intra_process_comms(true)) {
    pub_ = this->create_publisher<GpuBuffer>("gpu_topic", 10);
    sub_ = this->create_subscription<GpuBuffer>("gpu_topic", 10,
      [this](const GpuBuffer& msg) {
        float val;
        cudaMemcpy(&val, msg.dev_ptr, sizeof(float), cudaMemcpyDeviceToHost);
        RCLCPP_INFO(this->get_logger(), "SUB: Received %f from GPU", val);
        cudaFree(msg.dev_ptr); 
      });

    timer_ = this->create_wall_timer(1s, [this]() {
        auto msg = std::make_unique<GpuBuffer>();
        cudaMalloc(&msg->dev_ptr, sizeof(float));
        float pi = 3.14159f;
        cudaMemcpy(msg->dev_ptr, &pi, sizeof(float), cudaMemcpyHostToDevice);
        RCLCPP_INFO(this->get_logger(), "PUB: Sent GPU Pointer %p", (void*)msg->dev_ptr);
        pub_->publish(std::move(msg));
    });
  }
private:
  rclcpp::Publisher<GpuBuffer>::SharedPtr pub_;
  rclcpp::Subscription<GpuBuffer>::SharedPtr sub_;
  rclcpp::TimerBase::SharedPtr timer_;
};

int main(int argc, char** argv) {
  rclcpp::init(argc, argv);
  rclcpp::spin(std::make_shared<GpuBridgeNode>());
  rclcpp::shutdown();
  return 0;
}